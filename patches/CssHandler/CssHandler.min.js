"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function matchClass(e,t){if(!(e&&e.length&&t&&t.length))return!1;if(1==e.length&&1==t.length)return e[0]==t[0];if(e.length<t.length)return!1;for(var n=t;n--;){for(var r=!1,i=e.length;i--;)e[i]==t[n]&&(r=!0);if(!r)return!1}return!0}function matchStyle(e,t,n,r){if("*"==r)return 0;var i=r.match(/^[^\.#\s]+/),s=r.match(/\.[^\.#\s]+/g),a=r.match(/#[^\.#\s]+/);return a?n==a?s&&!matchClass(t,s)||i&&e!=i[0]?-1:2:-1:s?matchClass(t,s)?i&&e!=i[0]?-1:1:-1:i&&e==i[0]?0:-1}function parseCss(e,t){function n(){for(var t=1,n=a+1;n<e.length;n++)if("{"==e[n])t++;else if("}"==e[n]&&0==--t)break;l=n+1}var r=[];for(var i in config.userAgentStyles)t[i]?t[i]=config.userAgentStyles[i]+";"+t[i]:t[i]=config.userAgentStyles[i];for(var s in t)r.push({key:s,content:t[s]});var a,l=0;for(e=e.replace(/\/\*[\s\S]*?\*\//g,"");l<e.length&&-1!=(a=e.indexOf("{",l));){var u=e.substring(l,a);if("@"!=u[0])if(u=u.trim(),"}"==u[0]&&(u=u.substring(1)),"."==u[0]||"#"==u[0]||"["==u[0]||"*"==u[0]||u>="a"&&u<="z"||u>="A"&&u<="Z"){var o=u.split(",");if(l=a+1,-1==(a=e.indexOf("}",l)))break;var c=e.substring(l,a);l=a+1;for(var f=0;f<o.length;f++){var i={key:o[f].trim(),content:c};if(i.key.includes(":")){var h=i.key.split(":");if(i.key=h[0].trim(),i.pseudo=h.pop(),"before"!=i.pseudo&&"after"!=i.pseudo)continue}if(i.key.includes("[")&&(i.attr=[],i.key=i.key.replace(/\[(.+?)\]/g,function(e,t){if(t.includes("=")){var n=t.split("="),r=n[1].trim();('"'==r[0]&&'"'==r[r.length-1]||"'"==r[0]&&"'"==r[r.length-1])&&(r=r.substring(1,r.length-1)),i.attr.push({name:n[0].trim(),value:r})}else i.attr.push({name:t.trim()});return""}).trim(),i.key||(i.key="*")),i.key.includes(" ")||i.key.includes(">")){var d=i.key.replace(/\s*>\s*/g," >").split(/\s+/);i.list=d,i.key=d[0],i.index=0}r.push(i)}}else n();else if("@media"==u.substring(0,6)){var h=u.match(/\((.+?):(.+?)\)/);if(h&&h[2].includes("px")){var p=parseInt(h[2]);if("min-width"==h[1]&&config.screenWidth>p||"max-width"==h[1]&&config.screenWidth<p){l=a+1;continue}n()}}else n()}return r}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),config=require("./config.js"),CssHandler=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e),this.styles=Object.assign({},t)}return _createClass(e,[{key:"getStyle",value:function(e){var t="";return e=e.replace(/<[sS][tT][yY][lL][eE][\s\S]*?>([\s\S]*?)<\/[sS][tT][yY][lL][eE][\s\S]*?>/g,function(e,n){return t+=n,""}),this.styles=parseCss(t,this.styles),e}},{key:"match",value:function(e,t,n){var r=[];if(t.class)for(var i=t.class.split(/\s+/),s=i.length;s--;)r.unshift("."+i[s]);var a,l="",u="",o="",c=!1;n.i=[],n.index=[],n.pseudo=[];for(var f,s=0;f=this.styles[s];s++){">"==f.key[0]?(a=f.key.substring(1),c=!0):(a=f.key,c=!1);var h=matchStyle(e,r,t.id?"#"+t.id:"",a);if(-1!=h)if(f.hasOwnProperty("index")&&f.index!=f.list.length-1)n.i.push(s),n.index.push(f.index),f.index++,f.key=f.list[f.index];else{var d=!0;if(f.attr)for(var p=0;p<f.attr.length;p++)f.attr[p].hasOwnProperty("value")?t[f.attr[p].name]!=f.attr[p].value&&(d=!1):t.hasOwnProperty(f.attr[p].name)||(d=!1);d&&(f.pseudo?n.pseudo.push(f):0==h?l+=";"+f.content:1==h?u+=";"+f.content:o+=";"+f.content)}c&&(n.i.push(s),n.index.push(f.index),f.index--,f.key=f.list[f.index])}return n.i.length||(n.i=void 0,n.index=void 0),n.pseudo.length||(n.pseudo=void 0),l+";"+u+";"+o+";"}},{key:"pop",value:function(e){if(e.i){for(var t=0;t<e.i.length;t++){var n=e.i[t];this.styles[n].key=this.styles[n].list[e.index[t]],this.styles[n].index=e.index[t]}e.i=void 0,e.index=void 0}if(e.pseudo){var r=!0,i=!1,s=void 0;try{for(var a,l=e.pseudo[Symbol.iterator]();!(r=(a=l.next()).done);r=!0){var u,o=a.value,c=o.content.replace(/content:([^;\n]*)/,function(t,n){return u=n.replace(/attr\((.+?)\)/,function(t,n){return e.attrs[n.trim()]||""}).replace(/\s*['"](.*?)['"]\s*/g,"$1").replace(/\\(\w{4})/,function(e,t){return String.fromCharCode(parseInt(t,16))}),""}),f={name:"span",attrs:{style:c},children:[{type:"text",text:u}]};"before"==o.pseudo?e.children.unshift(f):e.children.push(f)}}catch(e){i=!0,s=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw s}}}}}]),e}();module.exports=CssHandler;